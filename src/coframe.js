var Coframejs;(()=>{"use strict";var e={d:(n,t)=>{for(var o in t)e.o(t,o)&&!e.o(n,o)&&Object.defineProperty(n,o,{enumerable:!0,get:t[o]})},o:(e,n)=>Object.prototype.hasOwnProperty.call(e,n),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},n={};function replaceHTMLContent(e,n,t){if(containsHTML(e)||containsHTML(n))setTimeout((function(){var o=document.createElement("div");o.innerHTML=e;var r=document.createElement("div");r.innerHTML=n;for(var i,a=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT,null);(i=a.nextNode())&&i.innerHTML.includes(e););i.parentElement&&function replaceNodeContent(e,n,t,o){for(var r=document.createDocumentFragment(),i=0,a=Array.from(e.childNodes);i<a.length;i++){var s=a[i];if(s.nodeType===Node.ELEMENT_NODE&&s instanceof Element&&s.outerHTML.includes(n.innerHTML)){s.setAttribute("coframe-id",o);var c=s.outerHTML.replace(n.innerHTML,t.innerHTML),d=document.createElement("div");d.innerHTML=c,d.firstChild&&r.appendChild(d.firstChild)}else r.appendChild(s)}e.textContent="",e.appendChild(r)}(i.parentElement,o,r,t)}),0);else for(var o=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,null),r=new RegExp(e,"g"),i=void 0;i=o.nextNode();)i.parentElement&&"script"!==i.parentElement.tagName.toLowerCase()&&i.textContent&&i.textContent.search(r)>=0&&(i.textContent=i.textContent.replace(r,n),i.parentElement.setAttribute("coframe-id",t))}function containsHTML(e){return/<[a-z][\s\S]*>/i.test(e)}e.r(n),e.d(n,{createSession:()=>createSession,getVariants:()=>getVariants,measureEngagement:()=>measureEngagement,sendEventToBackend:()=>sendEventToBackend,sendPageEngagementEvent:()=>sendPageEngagementEvent,sendSessionEvent:()=>sendSessionEvent});var t="coframe.user.token",getCookie=function(e){var n,t="; ".concat(document.cookie).split("; ".concat(e,"="));if(t.length>1)return null===(n=t.pop())||void 0===n?void 0:n.split(";").shift()},isCookieSet=function(e){return void 0!==getCookie(e)},setCookie=function(e,n){return document.cookie="".concat(e,"=").concat(n),isCookieSet(e)};const o={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let r;const i=new Uint8Array(16);function rng(){if(!r&&(r="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!r))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return r(i)}const a=[];for(let e=0;e<256;++e)a.push((e+256).toString(16).slice(1));function unsafeStringify(e,n=0){return a[e[n+0]]+a[e[n+1]]+a[e[n+2]]+a[e[n+3]]+"-"+a[e[n+4]]+a[e[n+5]]+"-"+a[e[n+6]]+a[e[n+7]]+"-"+a[e[n+8]]+a[e[n+9]]+"-"+a[e[n+10]]+a[e[n+11]]+a[e[n+12]]+a[e[n+13]]+a[e[n+14]]+a[e[n+15]]}const s=function v4(e,n,t){if(o.randomUUID&&!n&&!e)return o.randomUUID();const r=(e=e||{}).random||(e.rng||rng)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,n){t=t||0;for(let e=0;e<16;++e)n[t+e]=r[e];return n}return unsafeStringify(r)};var c,d,__awaiter=function(e,n,t,o){return new(t||(t=Promise))((function(r,i){function fulfilled(e){try{step(o.next(e))}catch(e){i(e)}}function rejected(e){try{step(o.throw(e))}catch(e){i(e)}}function step(e){e.done?r(e.value):function adopt(e){return e instanceof t?e:new t((function(n){n(e)}))}(e.value).then(fulfilled,rejected)}step((o=o.apply(e,n||[])).next())}))},__generator=function(e,n){var t,o,r,i,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function verb(s){return function(c){return function step(s){if(t)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(t=1,o&&(r=2&s[0]?o.return:s[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,s[1])).done)return r;switch(o=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,o=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(r=a.trys,(r=r.length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){a.label=s[1];break}if(6===s[0]&&a.label<r[1]){a.label=r[1],r=s;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(s);break}r[2]&&a.ops.pop(),a.trys.pop();continue}s=n.call(e,a)}catch(e){s=[6,e],o=0}finally{t=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},u=1e4,l=!1,f=[],m=[];function getVariants(e){return __awaiter(this,void 0,void 0,(function(){var n,t,o,r;return __generator(this,(function(i){switch(i.label){case 0:return n=localStorage.getItem("coframeVariants"),console.log("get",n),n?[2,JSON.parse(n)]:(t="".concat("http://localhost:8080/api/v1","/retrieve_variants_page/"),[4,fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({coframe_page_id:e,url:window.location.href})})]);case 1:return o=i.sent(),r=o.json(),localStorage.setItem("coframeVariants",JSON.stringify(r)),[2,r]}}))}))}function createSession(e,n,o,r){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(i){switch(i.label){case 0:return"https://ingest.coframe.com/ingest/v1/session_result/",[4,fetch("https://ingest.coframe.com/ingest/v1/session_result/",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({coframe_page_id:window.COFRAME_PAGE_ID,session_id:e,coframes:f,method:"scripts",metadata:{local_time:n,languages:void 0!==o?o.languages||o.language:[],platform:void 0!==o?o.platform||o.userAgentData&&o.userAgentData.platform:"",referrer:r,user_token:getCookie(t)}})})];case 1:return[2,i.sent().json()]}}))}))}function sendEventToBackend(e){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(t){switch(t.label){case 0:n="https://ingest.coframe.com/ingest/v1/events/".concat(window.COFRAME_PAGE_ID,"/"),t.label=1;case 1:return t.trys.push([1,3,,4]),[4,fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})];case 2:return[2,t.sent().json()];case 3:return t.sent(),[3,4];case 4:return[2]}}))}))}function sendSessionEvent(e){sendEventToBackend({type:e,coframe_page_id:window.COFRAME_PAGE_ID,session_id:d})}function measureEngagement(){var e=(new Date).getTime()-(c?c.getTime():0);!l&&e>=u?(l=!0,sendSessionEvent("session_start")):setTimeout(measureEngagement,u-e)}function updateViewedVariants(e){return function wrapped(){null==e||e.filter((function(e){var n=e.coframe_id;return!m.includes(n)})).forEach((function(e){var n=e.coframe_id;document.querySelectorAll('[coframe-id="'.concat(n,'"]')).forEach((function(e){(function isElementVisible(e){var n=e.getBoundingClientRect();return n.top>=0&&n.bottom<=window.innerHeight})(e)&&(e.setAttribute("coframe-experienced","true"),m.push(n),sendEventToBackend({type:"view",coframe_page_id:window.COFRAME_PAGE_ID,session_id:d,coframe_id:n}))}))}))}}function sendPageEngagementEvent(e,n,t){var o;return void 0===t&&(t=0),__awaiter(this,void 0,void 0,(function(){function getXPath(e){for(var n="";e&&1==e.nodeType;e=e.parentNode)if(e.parentNode){var t=Array.prototype.indexOf.call(e.parentNode.childNodes,e)+1,o=t>1?"["+t.toString()+"]":"";n="/"+e.tagName.toLowerCase()+o+n}return n}var r,i,a,s,c;return __generator(this,(function(u){return l||"click"!==e||(l=!0,sendSessionEvent("session_start")),r=n.clientX+window.scrollX,i=n.clientY+window.scrollY,a=window.innerWidth,s=window.innerHeight,(c=null===(o=n.target)||void 0===o?void 0:o.closest("a, button, input, [onclick], [href]"))||(c=n.target),sendEventToBackend({type:e,coframe_page_id:window.COFRAME_PAGE_ID,session_id:d,content:{html:c.outerHTML,xpath:getXPath(c),position:{x:Math.round(r),y:Math.round(i)},screen_size:{width:a,height:s},"duration-ms":Math.round(t)}}),[2]}))}))}var p={init:function(){return __awaiter(this,void 0,void 0,(function(){var e,n,o,r,i;return __generator(this,(function(a){switch(a.label){case 0:return e=window.COFRAME_PAGE_ID,new URLSearchParams(window.location.search).has("coframe_editor_id")?(n=document.createElement("script"),(n=document.createElement("script")).src="http://localhost:8082/ce.min.js",document.head.appendChild(n),[3,3]):[3,1];case 1:return e?[4,getVariants(e)]:[2];case 2:if(!(o=a.sent()).variants)return isCookieSet(t)||setCookie(t,s()),[2];r=o.variants,d=o.session_id,f=o.coframe_ids,c=new Date;try{r.forEach((function(e){replaceHTMLContent(e.original,e.copy,e.coframe_id)}))}catch(e){}isCookieSet(t)||setCookie(t,s()),createSession(d,c,navigator,document.referrer),sendSessionEvent("page_view"),window.addEventListener("beforeunload",(function(){sendSessionEvent("session_end")})),document.addEventListener("visibilitychange",measureEngagement),setTimeout(measureEngagement,u),document.addEventListener("coframe:dom-renderer:complete",updateViewedVariants(r)),document.addEventListener("scroll",updateViewedVariants(r)),document.dispatchEvent(new CustomEvent("coframe:dom-renderer:complete",{})),document.addEventListener("click",(function(e){return sendPageEngagementEvent("click",e)})),document.addEventListener("mouseover",(function(){i=Date.now()})),document.addEventListener("mouseout",(function(e){if(i){var n=Date.now()-i;n>=2e3&&sendPageEngagementEvent("hover",e,n)}})),setTimeout((function(){return measureEngagement()}),u),a.label=3;case 3:return[2]}}))}))},logCoframeConversion:function(e){sendEventToBackend({type:"conversion",coframe_page_id:window.COFRAME_PAGE_ID,session_id:d,label:e||""})}};window.Coframe=p,p.init(),console.log("Coframe initialized",p),Coframejs=n})();